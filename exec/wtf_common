#!/usr/bin/env bash

local nm_env="${CONTEXT_ORG}-${CONTEXT_ENV}"

function tf {
  if [[ -z "${CONTEXT_ORG:-}" ]]; then
    exec "$(basename "$(pwd)" | cut -d- -f2)" wtf "$@"
  fi

  if [[ -z "${CONTEXT_ENV:-}" ]]; then
    exec "$(basename "$(pwd)" | cut -d- -f3)" wtf "$@"
  fi

  tf_inner "$@"
}

function tf_inner {
  local nm_cmd="$1"; shift

  case "$nm_cmd" in
    get|remote)
      terraform "$nm_cmd" "$@"
      ;;

    *)
      terraform "$nm_cmd" \
        -var "vpc_name=${CONTEXT_ORG}-${CONTEXT_ENV}" \
        -var "context_org=${CONTEXT_ORG}" \
        -var "context_env=${CONTEXT_ENV}" \
        -var "bucket_remote_state=${CONTEXT_ORG}-remote-state" \
        "$@"
      ;;
  esac
}
